# 多模态气象数据蒸馏模型

## 项目概述

本项目实现了一种基于知识蒸馏的多模态气象数据生成模型，通过教师-学生架构实现从有ERA5条件的教师网络到无ERA5条件的学生网络的知识迁移。模型的核心创新在于设计了跨模态注意力机制和因果特征分解模块，实现了不同气象变量特征的有效融合和知识传递。

## 模型架构

### 核心组件

1. **ERA5多模态编码器**
   - 支持SST、MSL、Z、R四种气象变量
   - 使用3D卷积处理时间序列数据
   - 渐进式下采样：128×128 → 64×64 → 32×32 → 16×16

2. **跨模态注意力机制**
   - 6个注意力头，每个头64维
   - ERA5特征作为Query，卫星云图特征作为Key和Value
   - 在16×16和32×32两个分辨率层进行特征融合

3. **因果特征分解模块**
   - 通道级掩码，选择权重最高的70%通道作为因果特征
   - 梯度分离：因果特征参与梯度，非因果特征detach
   - 可学习掩码，通过训练自动学习最优分解策略

4. **因果效应矩阵**
   - 4×5的可学习因果效应矩阵
   - 通过反事实推理计算直接因果效应
   - 指数移动平均更新因果效应

5. **条件互信息损失**
   - 将不同模态特征映射到128维空间
   - 使用余弦相似度和二元交叉熵
   - 确保因果和非因果特征的分离

## 蒸馏策略

### 多层次特征蒸馏

1. **输出层蒸馏**: 学生网络输出与教师网络输出的MSE损失
2. **注意力特征蒸馏**: 16×16和32×32分辨率的注意力特征MSE损失
3. **编码器特征蒸馏**: 16×16和32×32分辨率的编码器特征MSE损失
4. **因果损失**: 条件互信息损失，权重自适应调整

### 自适应权重策略

- 基础权重：基于分数匹配损失和因果损失的比值
- 边界约束：限制权重在[0.01, 100]范围内
- 动态平衡：根据训练进度自动调整各损失项的权重

## 文件结构

```
best-distill/
├── code/
│   ├── models/
│   │   └── better/
│   │       └── ncsnpp_more.py          # 主要模型实现
│   ├── losses/
│   │   └── dsm.py                      # 蒸馏损失函数
│   ├── runners/
│   │   └── ncsn_runner.py              # 训练脚本
│   ├── tsne_visualization.py           # T-SNE可视化工具
│   ├── run_tsne_visualization.py       # 可视化运行脚本
│   ├── simple_tsne_demo.py             # 简化T-SNE演示
│   ├── simple_demo.py                  # 模型结构演示
│   └── distillation_model_analysis.md  # 详细模型分析文档
└── README.md                           # 项目说明
```

## 使用方法

### 1. 运行模型结构演示

```bash
cd best-distill/code
python3 simple_demo.py
```

这将展示模型的详细结构和各个组件的功能。

### 2. T-SNE可视化（需要安装依赖）

```bash
# 安装依赖
pip3 install numpy matplotlib scikit-learn tqdm

# 运行T-SNE可视化演示
python3 simple_tsne_demo.py
```

### 3. 真实数据可视化

```bash
python3 run_tsne_visualization.py \
    --mode real \
    --teacher_ckpt /path/to/teacher/checkpoint \
    --student_ckpt /path/to/student/checkpoint \
    --config_path /path/to/config.yaml \
    --data_path /path/to/test/data \
    --num_samples 1000 \
    --save_dir tsne_results
```

## 模型创新点

### 1. 跨模态注意力机制
- 多变量支持：同时处理SST、MSL、Z、R四种气象变量
- 分辨率自适应：在16×16和32×32两个分辨率层进行特征融合
- 多头注意力：使用6个注意力头捕获不同特征模式

### 2. 因果特征分解
- 通道级分解：在通道维度上分解因果和非因果特征
- 自适应掩码：通过可学习网络生成特征掩码
- 梯度分离：确保因果和非因果特征的独立性

### 3. 动态因果效应
- 可学习矩阵：因果效应矩阵通过训练自动学习
- 反事实推理：通过干预实验计算直接因果效应
- 动态更新：使用指数移动平均更新因果效应

### 4. 多层次蒸馏
- 四层蒸馏：输出层、注意力特征、编码器特征、因果特征
- 自适应权重：根据训练状态动态调整损失权重
- 变量权重：为不同气象变量学习独立权重

## 实验结果

### T-SNE可视化验证

通过T-SNE降维可视化验证蒸馏效果：

1. **特征对齐验证**: 学生网络特征是否成功靠近教师网络
2. **模态融合验证**: 不同ERA5变量的特征是否保持结构化分布
3. **知识迁移验证**: 从有ERA5条件的教师网络到无ERA5的学生网络的知识传递效果

### 特征相似度统计

模拟的蒸馏效果（余弦相似度）：

| 变量 | 编码器特征 | 注意力特征 |
|------|------------|------------|
| SST  | 0.9493     | 0.9082     |
| MSL  | 0.8780     | 0.9077     |
| Z    | 0.8905     | 0.9288     |
| R    | 0.9403     | 0.9251     |

相似度解读：
- 0.9-1.0: 极好的蒸馏效果，特征几乎完全对齐
- 0.8-0.9: 良好的蒸馏效果，特征高度相似
- 0.7-0.8: 中等蒸馏效果，特征基本对齐
- <0.7: 蒸馏效果较差，需要进一步优化

## 训练策略

### 损失函数组合

```
loss = loss_score + loss_distill + 10*loss_feat_encoder + lambda_adaptive*causal_loss
```

- `loss_score`: 分数匹配损失，与真实噪声的MSE
- `loss_distill`: 输出蒸馏损失，学生与教师输出的MSE
- `loss_feat_encoder`: 特征蒸馏损失，权重为10
- `causal_loss`: 因果损失，权重自适应调整

### 训练流程

1. 教师网络前向：使用ERA5条件生成特征
2. 学生网络前向：仅使用卫星云图条件生成特征
3. 特征提取：提取各层次的编码器和注意力特征
4. 损失计算：计算多层次蒸馏损失和因果损失
5. 反向传播：仅更新学生网络参数

## 总结

本文提出的多模态气象数据蒸馏模型通过创新的跨模态注意力机制、因果特征分解和自适应蒸馏策略，成功实现了从有ERA5条件的教师网络到无ERA5条件的学生网络的知识迁移。

### 模型的核心优势

1. **多模态融合**: 有效整合多种ERA5气象变量信息
2. **因果推理**: 通过因果特征分解提高模型的可解释性
3. **自适应学习**: 动态调整各组件权重，优化知识传递效果
4. **多层次蒸馏**: 从多个层次进行知识迁移，确保全面性

该模型为气象数据生成任务提供了一种新的解决方案，在保持生成质量的同时，显著降低了模型对ERA5数据的依赖。

## 引用

如果您使用了本项目的代码或方法，请引用相关论文：

```bibtex
@article{meteorological_distillation_2024,
  title={Multi-modal Meteorological Data Distillation with Cross-modal Attention and Causal Feature Decomposition},
  author={Your Name},
  journal={arXiv preprint},
  year={2024}
}
```

## 许可证

本项目采用MIT许可证。详见LICENSE文件。

## 联系方式

如有问题或建议，请通过以下方式联系：

- 邮箱：your.email@example.com
- GitHub Issues：https://github.com/your-repo/issues